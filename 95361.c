static void xhci_port_write(void *ptr, hwaddr uint64_t val, unsigned size) XHCIPort * port = ptr ; uint32_t portsc , notify ; switch ( reg )  if ( val & PORTSC_WPR )  if ( val & PORTSC_PR )  portsc = port -> portsc; notify = 0; portsc &= ~ ( val & ( PORTSC_CSC | PORTSC_PEC | PORTSC_WRC | PORTSC_OCC | PORTSC_PRC | PORTSC_PLC | PORTSC_CEC ) ); if ( val & PORTSC_LWS )  uint32_t old_pls = get_field ( port -> portsc , PORTSC_PLS ) ; uint32_t new_pls = get_field ( val , PORTSC_PLS ) ; switch ( new_pls )  if ( old_pls != PLS_U0 )  notify = PORTSC_PLC; portsc &= ~ ( PORTSC_PP | PORTSC_WCE | PORTSC_WDE | PORTSC_WOE ); portsc |= ( val & ( PORTSC_PP | PORTSC_WCE | PORTSC_WDE | PORTSC_WOE ) ); port -> portsc = portsc; if ( notify )  xhci_port_notify ( port , notify ); static void xhci_port_notify(XHCIPort *port, uint32_t bits) if ( ( port -> portsc & bits ) == bits )  port -> portsc |= bits; if ( ! xhci_running ( port -> xhci ) )  static inline int xhci_running(XHCIState *xhci) return ! ( xhci -> usbsts & USBSTS_HCH ) && ! xhci -> intr [ 0 ] . er_full ; xhci_event ( port -> xhci , & ev , 0 ); static void xhci_event(XHCIState *xhci, XHCIEvent *event, int v) XHCIInterrupter * intr ; dma_addr_t erdp ; unsigned int dp_idx ; if ( v >= xhci -> numintrs )  intr = & xhci -> intr [ v ]; if ( intr -> er_full )  erdp = xhci_addr64 ( intr -> erdp_low , intr -> erdp_high ); if ( erdp < intr -> er_start || erdp >= ( intr -> er_start + TRB_SIZE * intr -> er_size ) )  dp_idx = ( erdp - intr -> er_start ) / TRB_SIZE; assert ( dp_idx < intr -> er_size ); 