int CVE_2013_1707_PATCHED_NS_main(int argc, NS_tchar **argv) if ( argc < 3 )  gDestinationPath [ MAXPATHLEN - 1 ] = NS_T ( '\0' ); bool noServiceFallback = getenv ( "MOZ_NO_SERVICE_FALLBACK" ) != NULL ; useService = IsUpdateStatusPendingService ( ); testOnlyFallbackKeyExists = DoesFallbackKeyExist ( ); __int64 pid = 0 ; if ( argc > 3 )  pid = _wtoi64 ( argv [ 3 ] ); if ( pid == - 1 )  sBackgroundUpdate = true; if ( NS_tstrstr ( argv [ 3 ] , NS_T ( "/replace" ) ) )  sReplaceRequest = true; if ( sReplaceRequest )  NS_tchar installDir [ MAXPATHLEN ] ; if ( ! GetInstallationDir ( installDir ) )  if ( ! WriteStatusFile ( "applying" ) )  if ( pid > 0 )  HANDLE parent = OpenProcess ( SYNCHRONIZE , false , ( DWORD ) pid ) ; if ( parent )  DWORD result = WaitForSingleObject ( parent , 5000 ) ; if ( result != WAIT_OBJECT_0 )  const int callbackIndex = 5 ; sUsingService = getenv ( "MOZ_USING_SERVICE" ) != NULL; if ( ! sUsingService && ( argc > callbackIndex || sBackgroundUpdate || sReplaceRequest ) )  NS_tchar updateLockFilePath [ MAXPATHLEN ] ; if ( sBackgroundUpdate )  if ( sReplaceRequest )  NS_tchar installDir [ MAXPATHLEN ] ; if ( ! GetInstallationDir ( installDir ) )  if ( ! _waccess ( updateLockFilePath , F_OK ) && NS_tremove ( updateLockFilePath ) != 0 )  updateLockFileHandle = CreateFileW ( updateLockFilePath , GENERIC_READ | GENERIC_WRITE , 0 , NULL , OPEN_ALWAYS , FILE_FLAG_DELETE_ON_CLOSE , NULL ); if ( updateLockFileHandle == INVALID_HANDLE_VALUE || ( useService && testOnlyFallbackKeyExists && noServiceFallback ) )  GonkAutoMounter mounter ; if ( mounter . GetAccess ( ) != MountAccess :: ReadWrite )  if ( ! sReplaceRequest )  if ( NS_tchdir ( gDestinationPath ) != 0 )  int rv = NS_tmkdir ( gDestinationPath , 0755 ) ; if ( rv == OK && errno != EEXIST )  if ( NS_tchdir ( gDestinationPath ) != 0 )  if ( ! sReplaceRequest )  NS_tchar * destpath = ( NS_tchar * ) malloc ( ( NS_tstrlen ( gDestinationPath ) + 2 ) * sizeof ( NS_tchar ) ) ; if ( ! destpath )  NS_tchar * c = destpath ; NS_tstrcpy ( c , gDestinationPath ); c += NS_tstrlen ( gDestinationPath ); NS_tstrcat ( c , NS_T ( "/" ) ); c += NS_tstrlen ( NS_T ( "/" ) ); * c = NS_T ( '\0' ); c ++; gDestPath = destpath; 