 nsClipboard::SelectionGetEvent(GtkClipboard     GtkSelectionData *aSelectionData) int32_t whichClipboard ; GdkAtom selection = gtk_selection_data_get_selection ( aSelectionData ) ; if ( selection == GDK_SELECTION_PRIMARY )  whichClipboard = kSelectionClipboard; if ( selection == GDK_SELECTION_CLIPBOARD )  whichClipboard = kGlobalClipboard; nsCOMPtr < nsITransferable > trans = GetTransferable ( whichClipboard ) ; if ( ! trans )  nsresult rv ; nsCOMPtr < nsISupports > item ; uint32_t len ; GdkAtom selectionTarget = gtk_selection_data_get_target ( aSelectionData ) ; if ( selectionTarget == gdk_atom_intern ( "STRING" , FALSE ) || selectionTarget == gdk_atom_intern ( "TEXT" , FALSE ) || selectionTarget == gdk_atom_intern ( "COMPOUND_TEXT" , FALSE ) || selectionTarget == gdk_atom_intern ( "UTF8_STRING" , FALSE ) )  if ( gtk_targets_include_image ( & selectionTarget , 1 , TRUE ) )  static const char * const imageMimeTypes [ ] kNativeImageMime , kPNGImageMime , kJPEGImageMime , kJPGImageMime , kGIFImageMime nsCOMPtr < nsISupports > item ; nsCOMPtr < nsISupportsInterfacePointer > ptrPrimitive ; for (uint32_t i = 0; !ptrPrimitive && i < ArrayLength(imageMimeTypes); i++) rv = trans -> GetTransferData ( imageMimeTypes [ i ] , getter_AddRefs ( item ) , & len ); ptrPrimitive = do_QueryInterface ( item ); gchar * target_name = gdk_atom_name ( selectionTarget ) ; if ( ! target_name )  rv = trans -> GetTransferData ( target_name , getter_AddRefs ( item ) , & len ); if ( ! item || NS_FAILED ( rv ) )  void * primitive_data = nullptr ; if ( primitive_data )  if ( selectionTarget == gdk_atom_intern ( kHTMLMime , FALSE ) )  guchar * buffer = ( guchar * ) moz_xmalloc ( ( len * sizeof ( guchar ) ) + sizeof ( char16_t ) ) ; if ( ! buffer )  memcpy ( buffer , & prefix , sizeof ( prefix ) ); memcpy ( buffer + sizeof ( prefix ) , primitive_data , len ); primitive_data = ( guchar * ) buffer; free ( primitive_data ); 