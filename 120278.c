static int virtnet_probe(struct virtio_device *vdev) int i , err ; struct net_device * dev ; struct virtnet_info * vi ; u16 max_queue_pairs ; if ( ! vdev -> config -> get )  if ( ! virtnet_validate_features ( vdev ) )  static bool virtnet_validate_features(struct virtio_device *vdev) if ( ! virtio_has_feature ( vdev , VIRTIO_NET_F_CTRL_VQ ) && ( VIRTNET_FAIL_ON ( vdev , VIRTIO_NET_F_CTRL_RX , "VIRTIO_NET_F_CTRL_VQ" ) || VIRTNET_FAIL_ON ( vdev , VIRTIO_NET_F_CTRL_VLAN , "VIRTIO_NET_F_CTRL_VQ" ) || VIRTNET_FAIL_ON ( vdev , VIRTIO_NET_F_GUEST_ANNOUNCE , "VIRTIO_NET_F_CTRL_VQ" ) || VIRTNET_FAIL_ON ( vdev , VIRTIO_NET_F_MQ , "VIRTIO_NET_F_CTRL_VQ" ) || VIRTNET_FAIL_ON ( vdev , VIRTIO_NET_F_CTRL_MAC_ADDR , "VIRTIO_NET_F_CTRL_VQ" ) ) )  return false ; return true ; err = virtio_cread_feature ( vdev , VIRTIO_NET_F_MQ struct virtio_net_config max_virtqueue_pairs , & max_queue_pairs ) if ( err || max_queue_pairs < VIRTIO_NET_CTRL_MQ_VQ_PAIRS_MIN || max_queue_pairs > VIRTIO_NET_CTRL_MQ_VQ_PAIRS_MAX || ! virtio_has_feature ( vdev , VIRTIO_NET_F_CTRL_VQ ) )  max_queue_pairs = 1; dev = alloc_etherdev_mq ( sizeof ( struct virtnet_info ) , max_queue_pairs ); if ( ! dev )  dev -> priv_flags |= IFF_UNICAST_FLT | IFF_LIVE_ADDR_CHANGE; dev -> netdev_ops = & virtnet_netdev; dev -> features = NETIF_F_HIGHDMA; dev -> ethtool_ops = & virtnet_ethtool_ops; if ( virtio_has_feature ( vdev , VIRTIO_NET_F_CSUM ) )  dev -> hw_features |= NETIF_F_HW_CSUM | NETIF_F_SG | NETIF_F_FRAGLIST; if ( csum )  dev -> features |= NETIF_F_HW_CSUM | NETIF_F_SG | NETIF_F_FRAGLIST; if ( virtio_has_feature ( vdev , VIRTIO_NET_F_GSO ) )  dev -> hw_features |= NETIF_F_TSO | NETIF_F_UFO | NETIF_F_TSO_ECN | NETIF_F_TSO6; if ( virtio_has_feature ( vdev , VIRTIO_NET_F_HOST_TSO4 ) )  dev -> hw_features |= NETIF_F_TSO; if ( virtio_has_feature ( vdev , VIRTIO_NET_F_HOST_TSO6 ) )  dev -> hw_features |= NETIF_F_TSO6; if ( virtio_has_feature ( vdev , VIRTIO_NET_F_HOST_ECN ) )  dev -> hw_features |= NETIF_F_TSO_ECN; if ( virtio_has_feature ( vdev , VIRTIO_NET_F_HOST_UFO ) )  dev -> hw_features |= NETIF_F_UFO; dev -> features |= NETIF_F_GSO_ROBUST; if ( gso )  dev -> features |= dev -> hw_features & ( NETIF_F_ALL_TSO | NETIF_F_UFO ); if ( virtio_has_feature ( vdev , VIRTIO_NET_F_GUEST_CSUM ) )  dev -> features |= NETIF_F_RXCSUM; dev -> vlan_features = dev -> features; vi = netdev_priv ( dev ); vi -> dev = dev; vi -> vdev = vdev; vdev -> priv = vi; vi -> stats = alloc_percpu ( struct virtnet_stats ) if ( vi -> stats == NULL )  if ( virtio_has_feature ( vdev , VIRTIO_NET_F_MRG_RXBUF ) || virtio_has_feature ( vdev , VIRTIO_F_VERSION_1 ) )  vi -> hdr_len = sizeof ( struct virtio_net_hdr ); if ( virtio_has_feature ( vdev , VIRTIO_F_ANY_LAYOUT ) || virtio_has_feature ( vdev , VIRTIO_F_VERSION_1 ) )  vi -> any_header_sg = true; if ( virtio_has_feature ( vdev , VIRTIO_NET_F_CTRL_VQ ) )  vi -> has_cvq = true; vi -> curr_queue_pairs = 1; vi -> max_queue_pairs = max_queue_pairs; err = init_vqs ( vi ); static int init_vqs(struct virtnet_info *vi) int ret ; ret = virtnet_alloc_queues ( vi ); if ( ret )  ret = virtnet_find_vqs ( vi ); static int virtnet_find_vqs(struct virtnet_info *vi) vq_callback_t * * callbacks ; struct virtqueue * * vqs ; int i , total_vqs ; const char * * names ; total_vqs = vi -> max_queue_pairs * 2 + virtio_has_feature ( vi -> vdev , VIRTIO_NET_F_CTRL_VQ ); vqs = kzalloc ( total_vqs * sizeof ( * vqs ) , GFP_KERNEL ); if ( ! vqs )  callbacks = kmalloc ( total_vqs * sizeof ( * callbacks ) , GFP_KERNEL ); if ( ! callbacks )  names = kmalloc ( total_vqs * sizeof ( * names ) , GFP_KERNEL ); if ( ! names )  for (i = 0; i < vi->max_queue_pairs; i++) sprintf ( vi -> sq [ i ] . name , "output.%d" , i ); names [ txq2vq ( i ) ] = vi -> sq [ i ] . name; ret = vi -> vdev -> config -> find_vqs ( vi -> vdev , total_vqs , vqs , callbacks , names ); if ( ret )  vi -> rq [ i ] . vq = vqs [ rxq2vq ( i ) ]; vi -> sq [ i ] . vq = vqs [ txq2vq ( i ) ]; kfree ( names ); return ret ; 