static int virtnet_receive(struct receive_queue *rq, int budget) struct virtnet_info * vi = rq -> vq -> vdev -> priv ; unsigned int len , received = 0 ; void * buf ; while ( received < budget && ( buf = virtqueue_get_buf ( rq -> vq , & len ) ) != NULL )  receive_buf ( vi , rq , buf , len ); received ++; static void receive_buf(struct virtnet_info *vi, struct receive_queue void *buf, unsigned int len) struct net_device * dev = vi -> dev ; struct sk_buff * skb ; if ( unlikely ( len < vi -> hdr_len + ETH_HLEN ) )  if ( vi -> mergeable_rx_bufs )  skb = receive_mergeable ( dev , vi , rq , ( unsigned long ) buf , len ); static struct sk_buff *receive_mergeable(struct net_device struct virtnet_info struct receive_queue unsigned long unsigned int len) void * buf = mergeable_ctx_to_buf_address ( ctx ) ; static void *mergeable_ctx_to_buf_address(unsigned long mrg_ctx) return ( void * ) ( mrg_ctx & - MERGEABLE_BUFFER_ALIGN ) ; struct page * page = virt_to_head_page ( buf ) ; int offset = buf - page_address ( page ) ; unsigned int truesize = max ( len , mergeable_ctx_to_buf_truesize ( ctx ) ) ; static unsigned int mergeable_ctx_to_buf_truesize(unsigned long mrg_ctx) unsigned int truesize = mrg_ctx & ( MERGEABLE_BUFFER_ALIGN - 1 ) ; return ( truesize + 1 ) * MERGEABLE_BUFFER_ALIGN ; struct sk_buff * head_skb = page_to_skb ( vi , rq , page , offset , len , truesize ) ; static struct sk_buff *page_to_skb(struct virtnet_info struct receive_queue struct page *page, unsigned int unsigned int len, unsigned int truesize) struct sk_buff * skb ; struct virtio_net_hdr_mrg_rxbuf * hdr ; unsigned int copy , hdr_len , hdr_padded_len ; char * p ; p = page_address ( page ) + offset; skb = netdev_alloc_skb_ip_align ( vi -> dev , GOOD_COPY_LEN ); if ( unlikely ( ! skb ) )  hdr = skb_vnet_hdr ( skb ); static inline struct virtio_net_hdr_mrg_rxbuf *skb_vnet_hdr(struct sk_buff *skb) return ( struct virtio_net_hdr_mrg_rxbuf * ) skb -> cb ; hdr_len = vi -> hdr_len; if ( vi -> mergeable_rx_bufs )  hdr_padded_len = sizeof * hdr; hdr_padded_len = sizeof ( struct padded_vnet_hdr ); len -= hdr_len; p += hdr_padded_len; copy = len; if ( copy > skb_tailroom ( skb ) )  copy = skb_tailroom ( skb ); memcpy ( skb_put ( skb , copy ) , p , copy ); 