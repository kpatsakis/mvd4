static int virtnet_restore(struct virtio_device *vdev) struct virtnet_info * vi = vdev -> priv ; int err , i ; err = init_vqs ( vi ); static int init_vqs(struct virtnet_info *vi) int ret ; ret = virtnet_alloc_queues ( vi ); static int virtnet_alloc_queues(struct virtnet_info *vi) vi -> sq = kzalloc ( sizeof ( * vi -> sq ) * vi -> max_queue_pairs , GFP_KERNEL ); if ( ! vi -> sq )  vi -> rq = kzalloc ( sizeof ( * vi -> rq ) * vi -> max_queue_pairs , GFP_KERNEL ); if ( ! vi -> rq )  return 0 ; return - ENOMEM ; if ( ret )  ret = virtnet_find_vqs ( vi ); static int virtnet_find_vqs(struct virtnet_info *vi) vq_callback_t * * callbacks ; struct virtqueue * * vqs ; int i , total_vqs ; const char * * names ; total_vqs = vi -> max_queue_pairs * 2 + virtio_has_feature ( vi -> vdev , VIRTIO_NET_F_CTRL_VQ ); vqs = kzalloc ( total_vqs * sizeof ( * vqs ) , GFP_KERNEL ); if ( ! vqs )  callbacks = kmalloc ( total_vqs * sizeof ( * callbacks ) , GFP_KERNEL ); if ( ! callbacks )  names = kmalloc ( total_vqs * sizeof ( * names ) , GFP_KERNEL ); if ( ! names )  for (i = 0; i < vi->max_queue_pairs; i++) sprintf ( vi -> rq [ i ] . name , "input.%d" , i ); names [ rxq2vq ( i ) ] = vi -> rq [ i ] . name; static int rxq2vq(int rxq) return rxq * 2 ; names [ txq2vq ( i ) ] = vi -> sq [ i ] . name; static int txq2vq(int txq) return txq * 2 + 1 ; ret = vi -> vdev -> config -> find_vqs ( vi -> vdev , total_vqs , vqs , callbacks , names ); if ( ret )  vi -> rq [ i ] . vq = vqs [ rxq2vq ( i ) ]; static int rxq2vq(int rxq) return rxq * 2 ; vi -> sq [ i ] . vq = vqs [ txq2vq ( i ) ]; static int txq2vq(int txq) return txq * 2 + 1 ; kfree ( names ); return ret ; 